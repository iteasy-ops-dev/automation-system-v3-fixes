{
  "id": "IjJX9tJR4IPL76oa",
  "name": "Equipment Management Complete v3.1 - Fixed SSH",
  "active": true,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "equipment-complete",
        "responseMode": "onReceived",
        "responseData": "allEntries",
        "options": {}
      },
      "id": "A",
      "name": "Webhook Reception",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "functionCode": "// ìš”ì²­ ë°ì´í„° ë¡œê¹… ë° íŒŒì‹±\nconst requestData = $json;\nconsole.log('ğŸ“¥ Webhook ìˆ˜ì‹ :', JSON.stringify(requestData, null, 2));\n\n// í•„ìš”í•œ ë°ì´í„° ì¶”ì¶œ\nconst sessionId = requestData.sessionId || 'default-session';\nconst message = requestData.message || '';\nconst intent = requestData.intent || {};\nconst entities = requestData.entities || {};\n\n// ë°˜í™˜í•  ë°ì´í„° êµ¬ì„±\nreturn {\n  sessionId,\n  message,\n  intent,\n  entities,\n  timestamp: new Date().toISOString(),\n  workflowId: 'IjJX9tJR4IPL76oa'\n};"
      },
      "id": "B",
      "name": "Request Parser",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "url": "http://automation-llm-service:8301/api/v1/llm/chat",
        "method": "POST",
        "sendBody": true,
        "contentType": "json",
        "bodyParametersJson": "{\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"ë‹¹ì‹ ì€ IT ì¸í”„ë¼ ê´€ë¦¬ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ìš”ì²­ì„ ë¶„ì„í•˜ì—¬ ë‹¤ìŒ í˜•íƒœë¡œ ì‘ë‹µí•˜ì„¸ìš”:\\n\\n{\\n  \\\"action\\\": \\\"monitor_memory|monitor_cpu|monitor_disk|restart_service|check_logs\\\",\\n  \\\"target_device\\\": \\\"ì¥ë¹„ëª…\\\",\\n  \\\"command_type\\\": \\\"system_info|service_control|log_analysis\\\",\\n  \\\"details\\\": \\\"ì¶”ê°€ ì„¸ë¶€ì‚¬í•­\\\"\\n}\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": \"={{ $json.message }}\"\n    }\n  ],\n  \"model\": \"gpt-4\",\n  \"temperature\": 0.1\n}",
        "options": {}
      },
      "id": "C",
      "name": "LLM Provider Call",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "functionCode": "// LLM ì‘ë‹µ íŒŒì‹±\nconst llmResponse = $json;\nconsole.log('ğŸ¤– LLM ì‘ë‹µ:', JSON.stringify(llmResponse, null, 2));\n\n// LLM ì‘ë‹µì—ì„œ content ì¶”ì¶œ\nlet parsedIntent = {};\ntry {\n  const content = llmResponse.choices?.[0]?.message?.content || llmResponse.content || '{}';\n  console.log('ğŸ“ Content:', content);\n  \n  // JSON íŒŒì‹± ì‹œë„\n  parsedIntent = JSON.parse(content);\n} catch (error) {\n  console.log('âš ï¸ JSON íŒŒì‹± ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©:', error.message);\n  parsedIntent = {\n    action: 'monitor_memory',\n    target_device: '1',\n    command_type: 'system_info',\n    details: 'memory usage check'\n  };\n}\n\n// ì´ì „ ë°ì´í„°ì™€ ë³‘í•©\nconst previousData = $items()[0].json;\nreturn {\n  ...previousData,\n  parsedIntent,\n  action: parsedIntent.action || 'monitor_memory',\n  targetDevice: parsedIntent.target_device || '1'\n};"
      },
      "id": "D",
      "name": "Intent Parser",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [850, 300]
    },
    {
      "parameters": {
        "url": "http://automation-device-service:8101/api/v1/devices/by-name/={{ $json.targetDevice }}",
        "options": {},
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "id": "E",
      "name": "Device DB Query",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "functionCode": "// Device ì •ë³´ì™€ Connection ì •ë³´ ë³‘í•©\nconst deviceData = $json;\nconst previousData = $items()[0].json;\n\nconsole.log('ğŸ–¥ï¸ ì¥ë¹„ ì •ë³´:', JSON.stringify(deviceData, null, 2));\n\n// ì¥ë¹„ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸\nif (!deviceData || !deviceData.id) {\n  throw new Error(`ì¥ë¹„ '${previousData.targetDevice}'ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);\n}\n\nreturn {\n  ...previousData,\n  deviceInfo: deviceData,\n  deviceId: deviceData.id,\n  deviceName: deviceData.name,\n  connectionReady: true\n};"
      },
      "id": "F",
      "name": "Device Info Processor",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "url": "http://automation-device-service:8101/api/v1/internal/devices/by-name/={{ $json.targetDevice }}/connection",
        "options": {},
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "id": "G",
      "name": "Get Connection Info",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1450, 300]
    },
    {
      "parameters": {
        "functionCode": "// SSH ì—°ê²° ì„¤ì • - sshpass ì‚¬ìš©ìœ¼ë¡œ ìˆ˜ì •\nconst connectionInfo = $json;\nconst previousData = $items()[0].json;\n\nconsole.log('ğŸ” ì—°ê²° ì •ë³´:', JSON.stringify(connectionInfo, null, 2));\n\n// ì—°ê²° ì •ë³´ ê²€ì¦\nif (!connectionInfo.password || !connectionInfo.username || !connectionInfo.host) {\n  throw new Error('ì—°ê²° ì •ë³´ê°€ ë¶ˆì™„ì „í•©ë‹ˆë‹¤.');\n}\n\n// Actionì— ë”°ë¥¸ ëª…ë ¹ì–´ ì„¤ì •\nlet command = 'free -h'; // ê¸°ë³¸ê°’\nswitch (previousData.action) {\n  case 'monitor_memory':\n    command = 'free -h';\n    break;\n  case 'monitor_cpu':\n    command = 'top -bn1 | head -20';\n    break;\n  case 'monitor_disk':\n    command = 'df -h';\n    break;\n  case 'check_logs':\n    command = 'tail -50 /var/log/syslog';\n    break;\n  default:\n    command = 'free -h';\n}\n\n// â­ í•µì‹¬ ìˆ˜ì •: sshpass ì‚¬ìš©í•œ SSH ëª…ë ¹ì–´ êµ¬ì„±\nconst sshCommand = `sshpass -p \"${connectionInfo.password}\" ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no ${connectionInfo.username}@${connectionInfo.host} \"${command}\"`;\n\nconsole.log('ğŸ”§ SSH ëª…ë ¹ì–´ ìƒì„± ì™„ë£Œ (sshpass ì‚¬ìš©)');\n\n// MCP ì‹¤í–‰ì„ ìœ„í•œ ì„¤ì •\nconst mcpConfig = {\n  serverId: 'cbda6dfa-78a7-41a3-9986-869239873a72', // desktop-commander\n  tool: 'start_process',\n  params: {\n    command: sshCommand,\n    timeout_ms: 15000\n  },\n  async: false\n};\n\nreturn {\n  ...previousData,\n  connectionInfo,\n  sshCommand,\n  mcpConfig,\n  executeCommand: command\n};"
      },
      "id": "L",
      "name": "SSH Connection Setup",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1650, 300]
    },
    {
      "parameters": {
        "url": "http://automation-mcp-service:8201/api/v1/mcp/execute",
        "method": "POST",
        "sendBody": true,
        "contentType": "json",
        "bodyParametersJson": "{\n  \"serverId\": \"={{ $json.mcpConfig.serverId }}\",\n  \"tool\": \"={{ $json.mcpConfig.tool }}\",\n  \"params\": \"={{ JSON.stringify($json.mcpConfig.params) }}\",\n  \"async\": false\n}",
        "options": {}
      },
      "id": "H",
      "name": "MCP Tool Execution",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1850, 300]
    },
    {
      "parameters": {
        "functionCode": "// MCP ì‹¤í–‰ ê²°ê³¼ ì²˜ë¦¬\nconst mcpResult = $json;\nconst previousData = $items()[0].json;\n\nconsole.log('âš¡ MCP ì‹¤í–‰ ê²°ê³¼:', JSON.stringify(mcpResult, null, 2));\n\n// ì‹¤í–‰ ê²°ê³¼ ë¶„ì„\nlet executionSuccess = false;\nlet outputData = '';\nlet errorInfo = null;\n\nif (mcpResult && mcpResult.success) {\n  executionSuccess = true;\n  outputData = mcpResult.result?.output || mcpResult.output || '';\n  console.log('âœ… MCP ì‹¤í–‰ ì„±ê³µ');\n} else {\n  errorInfo = mcpResult.error || 'MCP ì‹¤í–‰ ì‹¤íŒ¨';\n  console.log('âŒ MCP ì‹¤í–‰ ì‹¤íŒ¨:', errorInfo);\n}\n\n// ì‘ë‹µ ë°ì´í„° êµ¬ì„±\nconst responseData = {\n  sessionId: previousData.sessionId,\n  workflowId: previousData.workflowId,\n  success: executionSuccess,\n  action: previousData.action,\n  targetDevice: previousData.targetDevice,\n  command: previousData.executeCommand,\n  output: outputData,\n  error: errorInfo,\n  timestamp: new Date().toISOString()\n};\n\nreturn responseData;"
      },
      "id": "I",
      "name": "Result Processor",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2050, 300]
    },
    {
      "parameters": {
        "url": "http://automation-llm-service:8301/api/v1/llm/chat",
        "method": "POST",
        "sendBody": true,
        "contentType": "json",
        "bodyParametersJson": "{\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"ë‹¹ì‹ ì€ IT ì‹œìŠ¤í…œ ê´€ë¦¬ìì…ë‹ˆë‹¤. ëª…ë ¹ì–´ ì‹¤í–‰ ê²°ê³¼ë¥¼ ì‚¬ìš©ìì—ê²Œ ì¹œê·¼í•˜ê³  ëª…í™•í•˜ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš”. ê¸°ìˆ ì ì¸ ë‚´ìš©ì„ ì¼ë°˜ì¸ë„ ì´í•´í•  ìˆ˜ ìˆê²Œ í•´ì„í•´ì£¼ì„¸ìš”.\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": \"ì¥ë¹„: {{ $json.targetDevice }}\\nëª…ë ¹ì–´: {{ $json.command }}\\nì‹¤í–‰ ê²°ê³¼:\\n{{ $json.output }}\\n\\nìœ„ ê²°ê³¼ë¥¼ í•´ì„í•´ì„œ ì‚¬ìš©ìì—ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš”.\"\n    }\n  ],\n  \"model\": \"gpt-4\",\n  \"temperature\": 0.3\n}",
        "options": {}
      },
      "id": "J",
      "name": "Response Generator",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2250, 300]
    },
    {
      "parameters": {
        "functionCode": "// ìµœì¢… ì‘ë‹µ êµ¬ì„±\nconst llmResponse = $json;\nconst previousData = $items()[0].json;\n\n// LLM ì‘ë‹µ ì¶”ì¶œ\nlet finalResponse = '';\ntry {\n  finalResponse = llmResponse.choices?.[0]?.message?.content || llmResponse.content || 'ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';\n} catch (error) {\n  finalResponse = 'ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';\n}\n\n// ìµœì¢… ì‘ë‹µ ë°ì´í„°\nconst finalResult = {\n  sessionId: previousData.sessionId,\n  success: previousData.success,\n  response: finalResponse,\n  executionDetails: {\n    workflowId: previousData.workflowId,\n    targetDevice: previousData.targetDevice,\n    action: previousData.action,\n    rawOutput: previousData.output,\n    timestamp: previousData.timestamp\n  }\n};\n\nconsole.log('ğŸ¯ ìµœì¢… ì‘ë‹µ:', JSON.stringify(finalResult, null, 2));\n\nreturn finalResult;"
      },
      "id": "K",
      "name": "Final Response",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2450, 300]
    }
  ],
  "connections": {
    "Webhook Reception": {
      "main": [[{"node": "Request Parser", "type": "main", "index": 0}]]
    },
    "Request Parser": {
      "main": [[{"node": "LLM Provider Call", "type": "main", "index": 0}]]
    },
    "LLM Provider Call": {
      "main": [[{"node": "Intent Parser", "type": "main", "index": 0}]]
    },
    "Intent Parser": {
      "main": [[{"node": "Device DB Query", "type": "main", "index": 0}]]
    },
    "Device DB Query": {
      "main": [[{"node": "Device Info Processor", "type": "main", "index": 0}]]
    },
    "Device Info Processor": {
      "main": [[{"node": "Get Connection Info", "type": "main", "index": 0}]]
    },
    "Get Connection Info": {
      "main": [[{"node": "SSH Connection Setup", "type": "main", "index": 0}]]
    },
    "SSH Connection Setup": {
      "main": [[{"node": "MCP Tool Execution", "type": "main", "index": 0}]]
    },
    "MCP Tool Execution": {
      "main": [[{"node": "Result Processor", "type": "main", "index": 0}]]
    },
    "Result Processor": {
      "main": [[{"node": "Response Generator", "type": "main", "index": 0}]]
    },
    "Response Generator": {
      "main": [[{"node": "Final Response", "type": "main", "index": 0}]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}